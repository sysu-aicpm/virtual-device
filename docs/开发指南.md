# 开发指南

## 项目结构

```
virtual-device/
├── app.py              # 主应用入口
├── config.py           # 配置文件
├── requirements.txt    # 项目依赖
├── device/            # 设备模块
│   ├── __init__.py    # 模块初始化
│   ├── base_device.py # 基础设备类
│   └── devices.py     # 具体设备实现
└── docs/              # 文档
    ├── API.md         # API文档
    ├── 设备说明.md     # 设备功能说明
    └── 开发指南.md     # 本文档
```

## 添加新设备类型

### 1. 继承基础设备类

所有新设备都应继承 `BaseDevice` 类：

```python
from .base_device import BaseDevice

class NewDevice(BaseDevice):
    def __init__(self, device_id):
        super().__init__(device_id, "new_device_type")
        # 初始化设备特有属性
        self.some_property = initial_value
        self.power = default_power  # 设置默认功耗
```

### 2. 实现控制方法

必须实现 `control` 方法来处理设备特有的控制命令：

```python
def control(self, action, params):
    if action == "some_action":
        value = params.get("param_name")
        if value is not None and self._validate_value(value):
            self.some_property = value
            return True
    return False
```

### 3. 注册设备类型

在 `app.py` 中的 `DEVICE_MAPPING` 字典中注册新设备：

```python
DEVICE_MAPPING = {
    'existing_device': ExistingDevice,
    'new_device': NewDevice  # 添加新设备
}
```

### 4. 添加键盘事件处理（可选）

在 `app.py` 的 `on_key_press` 函数中添加新设备的键盘事件处理：

```python
def on_key_press(key):
    try:
        if isinstance(device, NewDevice) and key.char == 'x':
            # 处理键盘事件
            device.some_property = new_value
            device.send_event(
                config.CONTROLLER_URL,
                "event_type",
                {"property": new_value}
            )
    except AttributeError:
        pass
```

## 最佳实践

### 1. 状态管理
- 所有状态变化都应该通过 `control` 方法进行
- 重要状态变化应该触发事件通知
- 使用有意义的状态名称（如 "on"/"off"，"locked"/"unlocked" 等）

### 2. 错误处理
- 在 `control` 方法中验证所有输入参数
- 使用合理的参数范围限制
- 返回 `False` 表示控制失败，而不是抛出异常

### 3. 事件通知
- 事件类型应该清晰表明发生了什么
- 事件数据应该包含足够的信息以理解状态变化
- 使用 ISO 格式的时间戳

### 4. 功耗管理
- 设置合理的默认功耗
- 如果设备功耗会随状态变化，确保及时更新
- 功耗单位统一使用瓦特（W）

### 5. 文档
- 在设备类中添加详细的文档字符串
- 说明所有可用的控制命令和参数
- 描述设备的特有行为和限制

## 示例：新设备实现

这是一个智能窗帘的实现示例：

```python
class Curtain(BaseDevice):
    def __init__(self, device_id):
        super().__init__(device_id, "curtain")
        self.position = 0  # 0: 完全关闭, 100: 完全打开
        self.power = 8  # 默认功耗8W
        self.status = "closed"

    def control(self, action, params):
        if action == "set_position":
            position = params.get("position")
            if position is not None and 0 <= position <= 100:
                self.position = position
                self.status = "open" if position > 0 else "closed"
                return True
        elif action == "switch":
            state = params.get("state")
            if state in ["open", "close"]:
                self.position = 100 if state == "open" else 0
                self.status = state + "d"  # "opened" or "closed"
                return True
        return False
```

## 测试新设备

1. 基本功能测试：
```bash
# 设置设备类型
export DEVICE_TYPE=new_device_type

# 启动设备
python app.py
```

2. API测试：
```bash
# 查询设备状态
curl -X POST http://localhost:5000/query \
     -H "Content-Type: application/json" \
     -d '{"keys": ["status", "some_property"]}'

# 控制设备
curl -X POST http://localhost:5000/control \
     -H "Content-Type: application/json" \
     -d '{"action": "some_action", "params": {"param_name": "value"}}'
``` 